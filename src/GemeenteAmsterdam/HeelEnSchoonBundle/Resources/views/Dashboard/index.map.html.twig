{% extends 'HeelEnSchoonBundle:Dashboard:_base.html.twig' %}

{% block body %}
    <body>

        <header class="banner">
            <div class="banner-wrapper">
                <div class="banner-container">
                    <a href="{{ path('gemeenteamsterdam_heelenschoon_dashboard_index') }}" class="banner-cleanstreet">
                        <img src="/img/clean-street-logo.svg" alt="clean street">
                    </a>
                    <img src="/img/adam-logo.svg" class="banner-amsterdam" alt="gemeente amsterdam">
                </div>
            </div>
        </header>

        <nav class="main-nav" id="sticky-nav">
            <div class="main-nav-wrapper">
                <div class="main-nav-container">
                    {% if filter.datumAangemaakt is defined %}
                        <h1 class="dashboard-day">
                        <a href="?datumAangemaakt={{ filter.datumAangemaakt|date_modify('-1 day')|date('Y-m-d') }}" class="dashboard-arrow prev">&#9668;</a>
                        <span class="dashboard-datepicker" id="pikaday">{{ filter.datumAangemaakt|localizeddate('none', 'none', 'nl', false, 'EEEE d MMMM YYYY') }}</span>
                        {% if filter.datumAangemaakt|date('Y-m-d') < 'now'|date('Y-m-d') %}
                            <a href="?datumAangemaakt={{ filter.datumAangemaakt|date_modify('+1 day')|date('Y-m-d') }}" class="dashboard-arrow">&#9658;</a>
                        {% endif %}
                        </h1>
                    {% endif %}
                </div>
            </div>
        </nav>

        <section class="dashboard">

            <div class="dashboard-wrapper">
                {% include 'HeelEnSchoonBundle:Dashboard:_map.html.twig' %}
            </div>
        </section>

        <footer class="main-footer">
            <div class="wrapper">
                <p>Clean street is een initiatief van de Gemeente Amsterdam</p>
            </div>
        </footer>

        <script src="/assets/js/jquery.sticky.js"></script>
        <script src="/assets/js/jail.min.js"></script>
        <script src="/assets/js/moment.min.js"></script>
        <script src="/assets/js/pikaday/pikaday.js"></script>
        <script src="/assets/js/leaflet.js"></script>

        <script>
            // Markers based on ticket geo

            var TicketMakers;

            var ticketMarkers = [{% for ticket in tickets %}{% spaceless %}{% if ticket.geo is not empty %}
                {% set lat %}{{ ticket.geo|slice(16,16) }}{% endset %}
                {% set lng %}{{ ticket.geo|slice(33,-1) }}{% endset %}
                [{{ lat }}, {{ lng }}]{% if not(loop.last) %},{% endif %}
            {% endif %}{% endspaceless %}{% endfor %}];
        </script>

        <script>
            // Load map

            var mymap = L.map('mapid').setView([52.3748, 4.8948], 16);

            L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
                attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
                maxZoom: 18,
                id: 'mapbox.streets',
                accessToken: 'pk.eyJ1IjoiYWRyaWFhbnR2IiwiYSI6ImNqNjI3d29sczB2bnUzM2w0c2Jjb2IxcDQifQ.bJW5d7HvDnJnSs2vpVqD9Q'
            }).addTo(mymap);

           var greenIcon = new L.Icon({
                iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

            var greyIcon = new L.Icon({
                iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-grey.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

            var dam = [
                [
                    4.8986363,
                    52.3769353
                ],
                [
                    4.8985934,
                    52.3778129
                ],
                [
                    4.8975635,
                    52.3782976
                ],
                [
                    4.8968124,
                    52.3775641
                ],
                [
                    4.8961473,
                    52.3765423
                ],
                [
                    4.895246,
                    52.3759398
                ],
                [
                    4.8945165,
                    52.3752717
                ],
                [
                    4.8935509,
                    52.374656
                ],
                [
                    4.8928857,
                    52.374001
                ],
                [
                    4.8923707,
                    52.3735949
                ],
                [
                    4.8913407,
                    52.3736342
                ],
                [
                    4.8915553,
                    52.3724945
                ],
                [
                    4.8926067,
                    52.3724945
                ],
                [
                    4.8934221,
                    52.3723504
                ],
                [
                    4.8953962,
                    52.3718263
                ],
                [
                    4.8957825,
                    52.3719181
                ],
                [
                    4.8941517,
                    52.3724814
                ],
                [
                    4.8944736,
                    52.3730054
                ],
                [
                    4.8938084,
                    52.3733198
                ],
                [
                    4.8986363,
                    52.3769353
                ]
            ].map(function (el) {
                return [el[1], el[0]];
            });

            var rembrandtplein = [
                [
                    4.8935509,
                    52.3670378
                ],
                [
                    4.8931324,
                    52.3660551
                ],
                [
                    4.8952568,
                    52.3657603
                ],
                [
                    4.8954391,
                    52.3649218
                ],
                [
                    4.8962545,
                    52.3649545
                ],
                [
                    4.8961473,
                    52.365531
                ],
                [
                    4.8976278,
                    52.3657145
                ],
                [
                    4.8973811,
                    52.3669919
                ],
                [
                    4.8935509,
                    52.3670378
                ]
            ].map(function (el) {
                return [el[1], el[0]];
            });

            var plein4045 = [
            [
                4.8190069,
                52.3762541
              ],
              [
                4.8195648,
                52.3761232
              ],
              [
                4.8207235,
                52.3790835
              ],
              [
                4.8216677,
                52.3789263
              ],
              [
                4.822011,
                52.3793455
              ],
              [
                4.8241138,
                52.3791621
              ],
              [
                4.8249292,
                52.3806291
              ],
              [
                4.8365593,
                52.3787692
              ],
              [
                4.8368597,
                52.3792145
              ],
              [
                4.8328257,
                52.379817
              ],
              [
                4.8255301,
                52.3809697
              ],
              [
                4.8212385,
                52.3816507
              ],
              [
                4.8209381,
                52.3806029
              ],
              [
                4.8199081,
                52.3792145
              ],
              [
                4.8193932,
                52.3777998
              ],
              [
                4.8190069,
                52.3762541
            ]
            ].map(function (el) {
                return [el[1], el[0]];
            });

            var leidseplein = [
             [
                4.886148,
                52.3658455
              ],
              [
                4.8831654,
                52.3644959
              ],
              [
                4.8826611,
                52.3647514
              ],
              [
                4.8821139,
                52.3645156
              ],
              [
                4.8823822,
                52.3640308
              ],
              [
                4.8837233,
                52.3632184
              ],
              [
                4.8840988,
                52.3630087
              ],
              [
                4.8854935,
                52.3636049
              ],
              [
                4.8858154,
                52.3638932
              ],
              [
                4.8855472,
                52.364057
              ],
              [
                4.8850751,
                52.3637687
              ],
              [
                4.8837876,
                52.364568
              ],
              [
                4.886266,
                52.3657276
              ],
              [
                4.886148,
                52.3658455
              ]
            ].map(function (el) {
                return [el[1], el[0]];
            });

            function drawMarkers(coords) {
                for (var i=0; i < coords.length; i++) {
                    var marker = L.marker(coords[i],{icon: greenIcon}).addTo(mymap);
                    marker.bindPopup("<b>Ticket</b>");
                }
            }

            drawMarkers(ticketMarkers);

            // Draw gebieden / areas on map
            var polygonDam = L.polygon(dam, {color: 'green'}).addTo(mymap);
            var polygonRembrandtplein = L.polygon(rembrandtplein, {color: 'green'}).addTo(mymap);
            var polygonLeidseplein = L.polygon(leidseplein, {color: 'green'}).addTo(mymap);
            var polygonPlein4045 = L.polygon(plein4045, {color: 'green'}).addTo(mymap);

            // zoom the map to the polygon
            mymap.fitBounds(polygonDam.getBounds());

        </script>
        <script>
        $( document ).ready(function() {

            // Lazy load photos
            $('.dashboard-photo').jail({effect: 'fadeIn', speed: 200});

            // Sticky nav
            $("#sticky-nav").sticky({zIndex:2000, responsiveWidth:false});

            // Counts per filter
            $("#filter-open .dashboard-filter-count").html("(" + $(".dashboard-item[data-status=open]").length + ")");
            $("#filter-gesloten .dashboard-filter-count").html("(" + $(".dashboard-item[data-status=gesloten]").length + ")");
            $("#filter-opgelost .dashboard-filter-count").html("(" + $(".dashboard-item[data-solution=opgelost]").length + ")");
            $("#filter-niet-opgelost .dashboard-filter-count").html("(" + $(".dashboard-item[data-solution='niet-opgelost']").length + ")");
            $("#filter-onbekend .dashboard-filter-count").html("(" + $(".dashboard-item[data-solution=onbekend]").length + ")");
            $("#filter-geleegd .dashboard-filter-count").html("(" + $(".dashboard-item[data-solution=geleegd]").length + ")");

            // Click filter
            $(".dashboard-filter").click(function(e) {
                e.preventDefault();
                var filter = $(this).attr("id").substr("filter-".length);
                localStorage.setItem("filter", filter);
                $(".dashboard-filter").removeClass("active");
                $(this).addClass("active");
                $(".dashboard-item").fadeOut(200);
                setTimeout(function () {
                    switch (filter) {
                        case "open":
                        case "gesloten":
                            $(".dashboard-item[data-status=" + filter + "]").fadeIn(200);
                            break;
                        case "opgelost":
                        case "niet-opgelost":
                        case "onbekend":
                        case "geleegd":
                            $(".dashboard-item[data-solution=" + filter + "]").fadeIn(200);
                            break;
                        case "alles":
                        default:
                            $(".dashboard-item").fadeIn(200);
                    }
                }, 200);
            });

            var filter = localStorage.getItem("filter") || "alles";
            $("#filter-" + filter).click();

            // Pikaday date picker
            var headerdate = new Pikaday({
                field: document.getElementById('pikaday'),
                format: 'YYYY-MM-DD',
                theme: 'cleanstreet-theme',
                onSelect: function(date) {
                    window.location = '?datumAangemaakt=' + headerdate.toString();
                }
            });

        });
        </script>
    </body>
{% endblock %}